# 스트림 프로세싱

* 카프카는 이벤트 스트림을 전달할 수 있는 강력한 메시지 버스

## 스트림 프로세싱이란?

* 이벤트 스트림은 무한 데이터 셋을 나타내는 추상 개념, 끊임 없이 데이터가 전달됨
* 다양한 업무 활동에서 이벤트 스트림은 나타남(주식 거래, 택배, 신용카드 거래 등등)

### 이벤트 스트림에는 순서가 있다

* 이벤트는 다른 이벤트 전이나 후에 발생한다.
* 이벤트 스트림과 관계형 데이터베이스가 다른점은 관계형 데이터베이스는 레코드에 순서가 없다고 간주함

### 불변 데이터 레코드

* 이벤트 자체는 일단 발생하면 변경될 수 없음
* 관계형 데이터베이스와 다른점은 이벤트 스트림에는 스트림 자체에 모든 트랜잭션이 수록

### 이벤트 스트림은 재생 가능할 수 있다

* 에러 수정, 새로운 분석 방법 시도, 데이터 검토 등을 위해 재생 가능해야 한다.
* 이벤트 스트림은 캡쳐하고 재생할 수 있다.

## 스트림 프로세싱이란?

* 스트림 프로세싱은 하나 이상의 이벤트 스트림을 처리하는 것을 나타냄
* 스트림 프로세싱은 요청-응답, 배치 처럼 프로그래밍 패러다임중 하나이다.

### 요청-응답

* 애플리케이션이 요청을 전송한 후 프로세싱 스시템의 응답을 기다리는 형태

### 배치 프로세싱

* 지연은 많지만 처리량이 높은 형태
* 시스템이 설정한 시간에 동작
* 효율성이 크고 대량의 데이터를 일괄 처리 할 수 있음

### 스트림 프로세싱

* 연속적이고 중단되지 않는 패러다임
* 요청-응답과 배치 프로세싱간의 격차를 줄여줌
* 지속적이지만 중단되지 않는 프로세싱에 적합

## 스트림 프로세싱의 개념

* 스트림 프로세싱은 데이터를 읽고 처리한 후 결과를 저장하는 유형의 데이터 프로세싱과도 유사
* 그러나 스트림 프로세싱에만 있는 고유한 핵심 개념들이 있음

### 시간

* 대부분의 스트림 프로세싱 작업은 타임 윈도우 작업으로 수행

#### 이벤트 시간

* 추적하는 이벤트가 발생하여 레코드가 생성된 시간
* 이벤트 시간은 스트림 데이터를 처리할 때 가장 중요한 시간이다.

#### 로그 추가 시간

* 이벤트가 카프카 브로커에 전송되어 자장된 시간
* 레코드가 생성된 후에는 이 시간이 변경되지 않는다.

#### 처리 시간

* 스트림 프로세싱 애플리케이션이 처리를 수행하기 위해 이벤트를 받은 시간
* 같은 애플리케이션의 다른 스레드에서도 다를 수 있기 때문에 신뢰성이 매우 낮은 시간 개념

### 상태

* 이벤트 간에 저장되는 정보를 상태라고 함
* 스트림 프로세싱에는 몇가지 유형의 상태가 있음

#### 로컬 또는 내부 상태

* 스트림 프로세싱 애플리케이션의 특정 인스턴에서만 사용할 수 있는 상태
* 애플리케이션 내부에 포함되어 메모리에서 실행
* 속도가 빠름
* 메모리 제한이 있음

#### 외부 상태

* 다른 시스템에 저장되고 유지 관리되는 상태
* 크기 제한이 없음
* 스트림 프로세싱 애플리케이션의 여러 인스턴스 또는 다른 애플리케이션에서도 사용 가능
* 지연이 있을 수 있음 


### 스트림과 테이블의 이원성

* 스트림은 변경 사항의 이력을 포함
* 스트림을 테이블로 변환하는 것을 스트림의 구체화라고 한다.

### 타임 윈도우

* 대부분의 스트림 작업은 타임 윈도우 작업으로 수행
* 타임 윈도우 크기에 따라 지연이 결정 됨
* 스트림따라 진행하는 간격이 타임 윈도우와 같다면 텀블링 윈도우, 다를 경우 호핑 윈도우라고 한다.

## 스트림 프로세싱 디자인 패턴

### 단일 이벤트 프로세싱

* 각 이벤트를 별개로 처리하는 방법
* 스트림으로부터 이벤트들을 읽고 변경한 후 다른 스트림으로 쓴다.

### 로컬 상태를 사용한 스트림 프로세싱

* 정보의 집계에 관심을 두는 경우가 많음
* 집계 하려는 데이터를 공유 상태가 아닌 로컬 상태에서 사용
* 메모리 사용과 영속성, 리밸런싱에 대한 고려가 필요하다.

### 다단계 프로세싱과 집계 파티션 생성

* 흩어져 있는 인스턴스 데이터를 하나의 파티션으로 모아서 접근하는 다단계 접근법을 사용

### 외부 데이터 검색을 사용하는 스트림 프로세싱: 스트림과 테이블 조인

* 스트림 프로세싱에서 외부 데이터를 스트림과 조인 해야 할 수도 있음
* 이 패턴에서는 외부 데이터 검색으로 인해 지연이 발생할 수 있음 
* 그렇기 때문에 외부 데이터베이스로부터 받은 정보를 캐싱해야 함
* 카프카 커넥터를 사용해 외부 데이터베이스 변경에 대한 부분을 캐시를 변경할 수 있음

### 스트리밍 조인

* 두 개의 실제 이벤트 스트림을 조인
* 두 스트림에서 같은 키와 같은 타임 우니도우를 갖은 이벤트들이 있으면 일치 시킴
* 그렇기 때문에 윈도우 조인이라고도 함

### 비순서적 이벤트

* 잘못된 시간에 스트림에 도달한 이벤트를 처리해야 하는 경우도 있음
* 프로세싱 시간과는 별개로 이벤트 시간의 개념을 사용

### 다시 프로세싱하기

### 토폴로지

* 토폴로지는 모든 이벤트가 입력에서 출력으로 이행하는 동안 수행되는 작업과 변환 처리의 집합
* 토폴로지는 항상 하나 이상의 소스 프로세서로 시작해서 하나 이상의 싱크 프로세서로 끝난다.

### 토폴로지 규모 확장

* 토폴로지 실행을 태스크로 분할
* 태스크 개수는 애플리케이션이 처리하는 토픽의 파티션 개수
* 리파티션이 필요할 때는 토폴로지가 두개의 서브 토폴로지로 나뉘며, 각각 별개의 태스크로 처리된다.
* 장점은 리파티션 된 토폴로지 태스크는 이전 태스크와 의존성이 없다.