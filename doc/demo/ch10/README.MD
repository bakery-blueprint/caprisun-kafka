# 카프카 모니터링
* 메트릭 : 성능이나 상태를 모니터링하기 위한 측정 지표

# 카프카 브로커 메트릭

## 미복제 파티션
* 클러스터의 각 브로커가 제공하는 이 메트릭은 리더 리플리카 브로커의 파티션을 팔로어 리플리카 브로커들이 복제하지 못한 파티션들의 총계를 제공한다.
* 값의 범위 : 0 이상의 정수
* 0이 아닌 숫자가 꾸준히 나타날 때는 클러스터의 브로커 중 하나가 오프라인 상태라는 것을 나타냄
* 미복제 파티션의 수가 변동되거나 오프라인 상태의 브로커가 하나도 없다면 클러스터 성능 문제
* 특정 브로커가 공통으로 나타나는지 살펴봐야 함

### 클러스터 수준의 문제
* 둘 중 하나의 문제, **부하 불균형**, **자원 고갈**
* 부하 불균형이라면 아래 메트릭을 통해 균형을 확인해야 한다.
  * 파티션 개수
  * 리더 파티션 개수
  * 모든 토픽의 메시지/바이트 입력 처리 속도
  * 모든 토픽의 바이트 출력 처리 속도
* 이것을 해결하려면 브로커의 파티션을 부하가 적은 브로커로 재할당 해야 한다.
* 클러스터 성능 문제일 경우 대부분 리소스 요인이 많음

### 호스트 수준의 문제
* 호스트의 하드웨어 장애나 구성의 차이 떄문에 발생할 수 있음

---

## 브로커 메트릭
### 엑티브 컨트롤러 수치
* 액티브 컨트롤러 수치 메트릭은 해당 브로커가 클러스터의 컨트롤러인지를 나타낸다.
* 반드시 하나의 컨트롤러만 있어야 한다.
* 값의 범위는 0 또는 1

### 요청 핸들러 유휴 비율
* 요청 핸들러(디스크 메시지를 읽거나, 클라이언트에 요청하는 책임을 가짐)의 작업량을 나타냄
* 사용중이 아닌 시간을 백분율로 표시
* 숫자가 작을 수록 브로커의 작업 부담이 커짐
* 스레드 풀의 수를 늘리거나 스레드가 불필요한 작업을 하는지 확인 필요

### 모든 토픽의 바이트 입력
* 브로커가 프로듀서 클라이언트로부터 받는 메시지 트래픽이 얼마인지 측정하는데 유용
* 클러스터 확장, 데이터 증가에 따른 작업 시기를 결정하는데 유용

### 모든 토픽의 바이트 출력
* 출력 속도는 컨슈머가 메시지를 읽는 속도를 보여준다.

### 모든 토픽의 메시지 입력
* 입력 속도는 메시지 크기와 무관하게 초당 입력되는 개별적인 메시지 수를 나타냄

### 오프라인 파티션
* 클러스터에서 현재 리더가 없는 파티션 개수를 나타냄
* 리더가 없는 파티션은 다음 두 가지 이유로 나타남
  * 해당 파티션의 리더나 팔로어인 모든 브로커들이 다운
  * 해당 파티션의 메시지 개수 불일치로 리더가 될수 있는 동기화 리플리카가 없고, 언클린 리더 순출이 불가능할 경우

---

## 토픽과 파티션 메트릭
* 클러스터의 트래픽을 많이 증가시키는 특정 토픽을 식별하기 위해 사용

### 토픽 메트릭
* 바이트 입력
* 바이트 출려 
* 읽기/쓰기 실패 요청 수
* 입력 메시지 수
* 전체 읽기/쓰기 요청 수

### 파티션 메트릭
* 파티션의 수가 너무 많은 경우가 많아 유용하게 사용하기 힘듬
* 다만 파티션 크기 메트릭 같은 경우 디스크에 저장된 데이터양을 나타내므로 카프카 비용을 계산하는데 사용 가능

---

## OS 모니터링
* 주로 살펴 보아야 할 것은 하드웨어 리소스 사용 정보

---

## 로깅 
* 적합은 로거를 적합한 레벨로 사용해야 함
* kafka.controller 로거는 클러스터 컨트롤러와 관련된(토픽 생성/변경, 브로커 상태 변경 등) 메시지를 제공

---

# 클라이언트 모니터링 

## 프로듀서 메트릭

### 전체 프로듀서 메트릭
### 프로듀서-브로커와 프로듀서-토픽 메트릭

---

## 컨슈머 메트릭

### Fetch 매니저 메트릭
### 컨슈머-브로커와 컨슈머-토픽 메트릭
### 컨슈머 조정자 메트릭

---

## 쿼터

---

# 지연 모니터링

# End-to-End 모니터링
